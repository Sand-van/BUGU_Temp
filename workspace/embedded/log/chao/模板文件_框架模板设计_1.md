# 模板文件的框架设计

----

## 模板文件的分类与定义

个人认为，我们工程的模板文件可以分为框架模板文件与程序描述模板文件
- 框架模板文件的作用，就是规定了工程内所有文件的物理关系（储存结构）与逻辑关系（依赖关系），指明了代码解析程序的构建文件（.json文件）与cmake的编译逻辑。
- 程序描述模板文件（.json文件）的作用，就是以特定的语法来描述用户程序的逻辑，即构建程序流程图。

----

## 框架模板文件的内容与对应语法

### 基本语法

这方面本人没有太好的想法，因此参考了makeFile与cmake文件的写法。(<value\>描述了一个整体变量，实际书写时不需要加<>号)

- `定义变量`：`<variableName> = <value>`
- `变量添加`：`<variableName> += <addValue>`
- `引用变量`：`${<variableName>}`
- `条件判断`：`if(<condition>)   endif()`

### 物理关系

为了便于管理各种文件，框架模板文件应该建立一个简明易懂的文件存储树，或者由用户指定。下面是一个stm32工程的例子:
```
project
 |-test.bgFrame (框架模板文件)
 |
 |-programDescriptionFile (程序描述文件夹)
 |  |-main.json
 |  |-userFunc.json
 |
 |-build（生成的目标文件）
 |  |-project.hex
 |  |-project.bin
 |
 |-source（生成的源文件）
    |-CMakeLists.txt
    |-src（.c文件夹）
    |  |-startup.s
    |  |-main.c
    |  |-userFunc.c
    |
    |-inc（.h文件夹）
    |  |-main.h
    |  |-userFunc.h
    |
    |-lib（库文件夹）
       |-CMSIS
       |-STM32F4xx_Driver
       |-BUGUcommonDriver
```
当然，物理关系还包括库（插件）的使用的模块，以减小文件体积。

这方面的基本语法有：

- `定义生成文件的存放位置`：`set_dictionary(<part> <dictionary>)`
- `使用某库`：`use_library(<libraryName1> <libraryName2> ...)`
- `使用某库的某模块`：`use_libraryModular(<libraryName> <modularName1> <modularName2> ...)`

### 逻辑关系

为了方面构建cmake文件，我们要描述各个库之间的依赖关系，.c.h文件的依赖关系

我们默认所有.c文件都包含main.h，其中main.h包含了所有库的定义头文件，即默认所有.c文件都依赖于库。

这方面的基本语法有：

- `要生成的.c.h文件`：`set_create_file(<fileName1> <fileName2> <fileName3>)` 其对应的生成内容位于./programDescriptionFile/ 下的同名.json文件内。

- `设置基本库的依赖库`：`set_based_library(<settingLibraryName> <basedLibraryName1> <basedLibraryName2>...)`

- `设置文件的依赖文件`：`set_based_file(<settingFile> <basedFileName1> <basedFileName2> ...)`

----

## 程序描述模板文件

程序描述文件，即用json语言描述的程序流程文件，是用户通过前端界面生成的结果，也是生成对应的c语言代码的唯一依据。一个json文件生成一对对应的.c.h文件，因此，json文件不仅要包含程序流程，还要包含依赖关系。

以下是json文件需要拥有的键值对以及对应语法

```json
{
    "fileName":<fileName>,
    "basedFile":[<fileName1>, <fileName2>, ...],    //为了.h的include编写
    "basedLibrary":[<libraryName1>, <libraryName2>, ...],
    "definitions":[{<definition1>}, {<definition2>}, ...],   //该文件的特殊定义，包括自定义结构体，枚举类型等
    "variables":[{<variable1>}, {<variable2>}, ...], //该文件的全局变量
    "functions":[{<function1>}, {<function2>}, ...]  //该文件的函数
}
```

其中，`definitions`，`variables`，`functions`中有进一步的键值对描述。

`definitions`：
```json
{
    "definitionType":<definition>,
    "content":[{<variable>}, {<enum>}, {<typeDef>}, {<macro>}, ...] //根据不同的definitionType决定其内容。
}
```

`variables`:
```json
{
    "variableName":<variableName>,
    "variableType":<variableType>,
    "isExternal":<boolean>    //是否能被其他文件引用
    //注：若是数组，则在type前面加上array<数组长度>，比如要定义一个5个长度的int8_t类型的数组，则<variableType>为"array5 int8_t"
}
```

`functions`:
```json
{
    "functionName":<functionName>,
    "functionReturnValueType":<variableType>,   //无返回就是NULL
    "functionParameters":[{<variable1>}, {<variable2>}, ...],
    "isExternal":<boolean>,   //是否能被其他文件引用
    "content":[{programDescription1}, {programDescription2}, ...]
}
```